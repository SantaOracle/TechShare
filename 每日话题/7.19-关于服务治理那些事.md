## 2017-7-19话题：关于服务治理 ##

### 上白板： ###

![](http://i.imgur.com/iKGgmIS.jpg)

### 话题重点： ###

- 限流

- 熔断

- 降级

## 限流： ##

### 什么是限流： ###

&nbsp;&nbsp;从字面上我们很好理解，限流，即限制流量。其目的是通过对并发访问/请求进行限速或者一个时间窗口内的的请求进行限速来保护系统，一旦达到限制速率则可以拒绝服务（定向到错误页或告知资源没有了）、排队或等待（比如秒杀、评论、下单）、降级（返回兜底数据或默认数据，如商品详情页库存默认有货）。

&nbsp;&nbsp;与熔断概念相比，限流是针对于provider端的操作，而熔断则是针对comsumer端的操作。

### 根据控制规模对限流分类： ###

&nbsp;&nbsp;我们根据可控的规模可以将限流分为：

- 单机限流

- 集群限流

&nbsp;&nbsp;单机限流，即针对单台机器进行QPS限制，当访问量超过这个阈值时，新的请求被拒绝（排队或抛弃）。这种限流策略，目前对应的技术主要为：Guava RateLimiter

&nbsp;&nbsp;集群限流，即对一个机器集群进行QPS限制。

### 其他限流分类： ###

- 限制总并发数：数据库连接池、线程池

- 限制瞬时并发数：nginx的limit_conn模块

- 限制时间窗口内平均速率：Guava的RateLimiter、nginx的limit_req模块

- 其他：限制远程接口调用速率、限制MQ的消费速率。另外还可以根据网络连接数、网络流量、CPU或内存负载等来限流

### 限流算法： ###

&nbsp;&nbsp;比较常见的限流算法有：令牌桶、漏桶。计数器也可以进行粗暴限流实现。

##### 令牌桶算法： #####


&nbsp;&nbsp;令牌桶算法是一个存放固定容量令牌的桶，按照固定速率往桶里添加令牌。

&nbsp;&nbsp;假设限制2r/s，则按照500毫秒的固定速率往桶中添加令牌；

&nbsp;&nbsp;桶中最多存放b个令牌，当桶满时，新添加的令牌被丢弃或拒绝；

&nbsp;&nbsp;当一个n个字节大小的数据包到达，将从桶中删除n个令牌，接着数据包被发送到网络上；

&nbsp;&nbsp;如果桶中的令牌不足n个，则不会删除令牌，且该数据包将被限流（要么丢弃，要么缓冲区等待）。

![](http://i.imgur.com/wJl7Kim.png)

&nbsp;&nbsp;在应对突发请求时，Guava RateLimiter提供了令牌桶算法实现：平滑突发限流(SmoothBursty)和平滑预热限流(SmoothWarmingUp)实现。

&nbsp;&nbsp;SmoothBursty通过平均速率和最后一次新增令牌的时间计算出下次新增令牌的时间的，另外需要一个桶暂存一段时间内没有使用的令牌（即可以突发的令牌数）。另外RateLimiter还提供了tryAcquire方法来进行无阻塞或可超时的令牌消费。

&nbsp;&nbsp;因为SmoothBursty允许一定程度的突发，会有人担心如果允许这种突发，假设突然间来了很大的流量，那么系统很可能扛不住这种突发。因此需要一种平滑速率的限流工具，从而系统冷启动后慢慢的趋于平均固定速率（即刚开始速率小一些，然后慢慢趋于我们设置的固定速率）。Guava也提供了SmoothWarmingUp来实现这种需求，其可以认为是漏桶算法，但是在某些特殊场景又不太一样。

##### 漏桶算法： #####

&nbsp;&nbsp;漏桶作为计量工具（The Leaky Bucket Algorithm as a Meter）时，可以用于流量整形（Traffic Shaping）和流量控制（TrafficPolicing）。其限流模型，可以参考迅雷下载时的限速策略。

&nbsp;&nbsp;一个固定容量的漏桶，按照常量固定速率流出水滴；

&nbsp;&nbsp;如果桶是空的，则不需流出水滴；

&nbsp;&nbsp;可以以任意速率流入水滴到漏桶；

&nbsp;&nbsp;如果流入水滴超出了桶的容量，则流入的水滴溢出了（被丢弃），而漏桶容量是不变的。

##### 令牌桶和漏桶算法的比较： #####

- 令牌桶是按照固定速率往桶中添加令牌，请求是否被处理需要看桶中令牌是否足够，当令牌数减为零时则拒绝新的请求；漏桶则是按照常量固定速率流出请求，流入请求速率任意，当流入的请求数累积到漏桶容量时，则新流入的请求被拒绝。

- 令牌桶限制的是平均流入速率（允许突发请求，只要有令牌就可以处理，支持一次拿3个令牌，4个令牌），并允许一定程度突发流量；漏桶限制的是常量流出速率（即流出速率是一个固定常量值，比如都是1的速率流出，而不能一次是1，下次又是2），从而平滑突发流入速率。

- 令牌桶允许一定程度的突发，而漏桶主要目的是平滑流入速率。

- 两个算法实现可以一样，但是方向是相反的，对于相同的参数得到的限流效果是一样的。

## 熔断： ##

### 什么是熔断： ###

&nbsp;&nbsp;熔断一词，源于股票市场。其是指当股指波幅达到某个点后，交易所为控制风险采取的暂停交易措施。相应的，服务熔断一般是指软件系统中，由于某些原因使得服务出现了过载现象，为防止造成整个系统故障，从而采用的一种保护措施，所以很多地方把熔断亦称为过载保护。

&nbsp;&nbsp;相比起限流，熔断则是针对consumer端的操作。

&nbsp;&nbsp;目前熔断使用的技术，常见的是Hystrix

### Hystrix支持的一些服务治理模式： ###

- 电路熔断模式

- 舱壁模式

- 请求合并

1.电路熔断模式：

&nbsp;&nbsp;该模式的原理类似于家里的电路熔断器，如果家里的电路发生短路，熔断器能够主动熔断电路，以避免灾难性损失。在分布式系统中应用电路熔断器模式后，当目标服务慢或者大量超时，调用方能够主动熔断，以防止服务被进一步拖垮；如果情况又好转了，电路又能自动恢复，这就是所谓的弹性容错，系统有自恢复能力。下图是一个典型的具备弹性恢复能力的电路保护器状态图，正常状态下，电路处于关闭状态(Closed)，如果调用持续出错或者超时，电路被打开进入熔断状态(Open)，后续一段时间内的所有调用都会被拒绝(Fail Fast)，一段时间以后，保护器会尝试进入半熔断状态(Half-Open)，允许少量请求进来尝试，如果调用仍然失败，则回到熔断状态，如果调用成功，则回到电路闭合状态。

![](http://i.imgur.com/sTtsC9k.png)

2.舱壁模式：

&nbsp;&nbsp;顾名思义，该模式像舱壁一样对资源或失败单元进行隔离，如果一个船舱破了进水，只损失一个船舱，其它船舱可以不受影响 。线程隔离(Thread Isolation)就是舱壁隔离模式的一个例子，假定一个应用程序A调用了Svc1/Svc2/Svc3三个服务，且部署A的容器一共有120个工作线程，采用线程隔离机制，可以给对Svc1/Svc2/Svc3的调用各分配40个线程，当Svc2慢了，给Svc2分配的40个线程因慢而阻塞并最终耗尽，线程隔离可以保证给Svc1/Svc3分配的80个线程可以不受影响，如果没有这种隔离机制，当Svc2慢的时候，120个工作线程会很快全部被对Svc2的调用吃光，整个应用程序会全部慢下来。

3.请求合并：

&nbsp;&nbsp;请求合并的含义是，对于类似的用户请求，服务端在收到请求后并不会立马向下一个服务端发送请求数据，而是在某一设定的时间内持续搜集请求。当达到时间上限时，本级服务端会统一向下一级服务端发送请求，并将收回的数据依次给消费者返回。如何判断一类请求，有一种实现方案是，设置KV，当检测请求匹配的key相同时，默认为同一类请求。这种模式的主要目的是减少服务方的rpc。

## 降级： ##

### 什么是降级： ###

&nbsp;&nbsp;我们可以举个常见的例子，女生出去旅游总喜欢带一堆东西，恨不得把整个家都搬出去。但是毕竟携带的东西有上限，有些东西必须要舍弃，那就只能舍掉这些东西，以后有更大的箱子装的时候再带上他们。服务降级也是这个道理，当客户端请求量达到一定量级导致系统将要无法正常运作的时候，部分不关键的服务可以暂停提供服务，以缓解系统压力，保证系统正常运行。

&nbsp;&nbsp;关键词句：利用有限资源，保障系统核心功能高可用、有损的架构方法。有限资源；核心高可用；有损；架构方法。

### 降级需要注意的点： ###

- 降级的对象：能力降级？质量降级？功能降级？

- 降级介入方式：人工？自动（需要考虑降级之后的恢复过程）？

- 降级的部分：哪些服务可以暂停，哪些服务必须死保

- 其他：降级必须有后备预案，必须考虑降级影响

### 部分降级示例： ###

- 牺牲部分用户体验

商详页不显示特色服务icon、促销信息等<br>
结算页不显示自提/311/411预约日历<br>
订单详情页不显示GIS订单轨迹、催单等<br>
评价列表禁止10页之后的翻页<br>
实时统计和报表禁用<br>
强制必选查询条件中的路由或索引字段<br>
领豆豆防刷降级为拼图验证<br>
H5变PC页面<br>
使用通用内容代替个性化推荐内容<br>

- 降低安全级别

发放京豆、提交订单、发表评论、登录不调用风控接口<br>
结算页前端下单不启用验证码<br>
集中式session不可用，cookie解密即可<br>
ip limit服务，注册、登录不限制次数<br>
商品修改内容不做敏感词过滤<br>
牺牲部分业务逻辑<br>
拍卖出价时不校验京豆数量<br>
发表评价，不再校验是否退货<br>

- 延缓任务处理

WMS任务处理引擎，暂停调拨、节能补贴等任务<br>
OFW优先处理高优先级、拆分逻辑较简单的订单<br>

- 损失数据持久性

用户地址更新，写redis，不回写数据库<br>
库存预占，写redis，异步回写数据库<br>
用户新增普票，写redis，不持久<br>
订单二次拆分任务机制，由JMQ降为redis队列<br>

- 降低准确性/实时性

实时价格过期不回源<br>
动态页变静态拖底页<br>
用户昵称接口降级，显示用户pin<br>
库存状态接口降级，显示有货<br>
抽奖异常，所有用户均显示未中奖<br>

- 降低性能

数据库代替缓存防重、查询<br>
数据库任务队列轮询代替MQ<br>
CDN降为源站<br>
本地缓存降为RPC<br>

- 降低容灾能力

自动调度变为手工调度<br>
VIP降级为real ip<br>

## 参考连接： ##

&nbsp;&nbsp;<a href="http://blog.csdn.net/g_hongjin/article/details/51649246">高并发系统之限流特技</a>

&nbsp;&nbsp;<a href="http://blog.csdn.net/he90227/article/details/51154429">微服务架构的设计与使用到的基础框架</a>

&nbsp;&nbsp;<a href="http://hot66hot.iteye.com/blog/2155036">Hystrix使用与分析</a>

&nbsp;&nbsp;<a href="http://blog.csdn.net/u010601183/article/details/54412666">服务降级背后的技术架构与设计</a>